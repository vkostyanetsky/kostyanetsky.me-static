

<!doctype html>
<html lang="ru" class="text-[18px] leading-[1.65]">
  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">

    <title>Non-Unique Metadata</title>

    <meta name="description" content="Once again encountered a bug: the platform breaks the data history metadata table." />
    
    <!-- RSS -->

    <link rel="alternate" type="application/rss+xml" title="Vlad's Site" href="https://kostyanetsky.me/rss.xml" />

    <!-- Icons -->

    <link rel="icon" href="https://kostyanetsky.me/favicon.ico">
    <link rel="icon" href="https://kostyanetsky.me/assets/icons/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="https://kostyanetsky.me/assets/icons/apple-touch-icon.png">
    <link rel="manifest" href="https://kostyanetsky.me/manifest.webmanifest">    

    <!-- Open Graph -->

    <meta property="og:title" content="Non-Unique Metadata"/>
    <meta property="og:description" content="Once again encountered a bug: the platform breaks the data history metadata table."/>
    <meta property="og:image" content="https://kostyanetsky.me/assets/images/og.jpg">
    <meta property="og:type" content="article"/>
    <meta property="og:url" content= "https://kostyanetsky.me/notes/data-history-duplication" />    

    <!-- CSS -->
     
    <link rel="stylesheet" href="/assets/css/tailwind.css">
    <link rel="stylesheet" href="/assets/css/site.css">

    <!-- Blog -->

    <script>
        let ctrlLeftUrl     = 'https://kostyanetsky.me/notes/uuid-main-issue';
        let ctrlRightUrl    = 'https://kostyanetsky.me/notes/singapore-doll';
    </script>
    
    <script src="https://kostyanetsky.me/assets/js/hotkeys.js"></script>    

  </head>

  <body class="min-h-screen bg-white text-slate-900">

    <!-- header -->
    <header class="border-b border-slate-200">
        <div class="mx-auto w-full max-w-4xl px-4 py-5">
            <div class="flex flex-wrap items-baseline gap-x-5 gap-y-2">

                <!-- header: main menu -->
                <nav class="flex flex-wrap items-baseline gap-x-5 gap-y-2 text-sm">
                    
                    
                    
                    
                    

                    
                    
                    <a class="inline-block text-[1.25rem] leading-tight mr-4 border-b border-current no-underline transition-opacity hover:opacity-70 text-blue-600" href="https://kostyanetsky.me/">Vlad's Site</a>
                    

                    
                    
                    <a class="inline-block text-[1.25rem] leading-tight mr-4 border-b border-current no-underline transition-opacity hover:opacity-70 text-blue-600" href="https://kostyanetsky.me/projects/">Projects</a>
                    

                    
                    
                    <a class="inline-block text-[1.25rem] leading-tight mr-4 border-b border-current no-underline transition-opacity hover:opacity-70 text-orange-600" href="https://kostyanetsky.me/notes/">Notes</a>
                    
                </nav>

                <!-- header: mirror link & edit link -->
                <div class="ml-auto flex items-center gap-4">
                    
                    
                        <a
                        title="Found a typo? Edit me!"
                        href="https://github.com/vkostyanetsky/kostyanetsky.me/edit/main/notes/data-history-duplication/index.md"
                        class="inline-block text-[1.35rem] leading-none text-blue-600 no-underline transition-opacity hover:opacity-70"
                        >✎</a>
                    
                    

                    
                    
                    <a
                        href="https://kostyanetsky.ru/notes/data-history-duplication"
                        class="inline-block text-[1rem] leading-tight text-blue-600 border-b border-current no-underline transition-opacity hover:opacity-70"
                        title="RU"
                    >
                        RU
                    </a>
                    
                </div>
            </div>
        </div>
    </header>

    <!-- content -->
    <main
      class="mx-auto w-full max-w-4xl px-4 py-10"
      id="pageMeta"
      data-page=""
      data-total-notes=""
      data-total-pages=""
    >
      <a id="top" class="block scroll-mt-24"></a>

      

      <section id="staticNotes" class="space-y-12">
        <article class="rounded-2xl bg-white">
          
          <header class="text-3xl font-semibold tracking-tight space-y-2">
            Non-Unique Metadata
          </header>

          <div class="mt-5">
            <div class="prose-like">
                

        <article class="rounded-2xl bg-white">

          <header class="space-y-2">

            

            <div class="flex flex-wrap items-center gap-x-3 gap-y-2 text-sm text-slate-600">
              <span>8 June 2024</span>
              
                <span class="text-slate-300">·</span>
                
                <div class="flex flex-wrap gap-2">
                    <span class="inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-2.5 py-1 text-xs text-slate-700">1С</span>
                </div>
                
                <div class="flex flex-wrap gap-2">
                    <span class="inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-2.5 py-1 text-xs text-slate-700">PostgreSQL</span>
                </div>
                
                <div class="flex flex-wrap gap-2">
                    <span class="inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-2.5 py-1 text-xs text-slate-700">MS SQL</span>
                </div>
                
              
            </div>

          </header>

          <div class="mt-5">
            <div class="prose-like">
              <p>Once again, I came across a nasty bug when the platform broke the data history metadata table.</p>
<p>Outwardly, it looks like this: you update the database configuration, and when you try to restructure, the error “The data history metadata table contains duplicate records. Delete the duplicate records” pops up. The platform does not offer any clear way to find such records.</p>
<p><img alt="The data history metadata table contains duplicate records. Delete the duplicate records" src="https://kostyanetsky.me/notes/data-history-duplication/error.png"/></p>
<p>The problem can be solved at the database level. The table referenced by the error is _DataHistoryMetadata. It contains metadata versions of each object for which data history is being maintained. This allows the platform to understand what attributes the object had at any point in time if the data history is maintained for the object.</p>
<p>How does it work? Well, when the list of an object’s attributes changes (for example, an attribute was added to the catalog), the platform writes its metadata: specifically, it adds a new entry to _DataHistoryMetadata and stores in it the current list of object attributes, as well as the version number of this list (for example, when history is enabled for an object, the first version of metadata is saved, when adding some attribute, the second version is saved, and so on).</p>
<p>The platform also puts a mark in the created record that this particular version of the object is the most actual, and then removes this mark from the version that was marked as actual before.</p>
<p>So, the problem is that the platform sometimes forgets to take the last step, and two versions appear in the table at once, marked as current. The Designer understands this but cannot do anything.</p>
<p>The solution follows from the algorithm above: you need to find conflicting versions and revoke the mark of actuality from the one that is older. It is better to use queries: data history is often enabled for a bunch of objects, and the list of their attributes is constantly changing — in general, there will be so many versions in the table that the devil will break his leg.</p>
<p>If you also encountered this problem and are therefore reading this text, you can use the <a href="https://gist.github.com/vkostyanetsky/6496c67e2b2fd3d064c4cafd16da0b79" target="_blank">queries</a> that I wrote:</p>
<ol>
<li>get-issues.sql checks that there is an issue: it looks for metadata versions that are also marked as actual.</li>
<li>fix-issues.sql removes the actuality mark from those versions that are actually outdated.</li>
</ol>
<p>Both queries are written for Microsoft SQL Server. If you use PostgreSQL, then <a href="https://gist.github.com/vkostyanetsky/75665ce04247e900743604eb386d1889" target="_blank">here they are</a> for this DBMS.</p>
<p>The queries will require a slight adaptation to a specific database: they use the _fld626 field, which is the data separator. In your _DataHistoryMetadata table, this field may be called differently, so you need to update its name to the current one. It will be difficult to make a mistake — the table has only one field with the _fld prefix.</p>
<p>P.S. Please bear in mind that the license agreement prohibits access to the database, bypassing the platform’s tools, so you can only go for such experiments if there are no other options left.</p>
            </div>
          </div>
          
        </article>


            </div>
          </div>

        </article>

      </section>
        
      <!-- Static pagination (works without JS; hide during search) -->
      <nav id="pagination" class="mt-10 flex items-center justify-between">
        
        <a
          id="prevLink"
          href="https://kostyanetsky.me/notes/uuid-main-issue"
          class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 transition hover:bg-slate-50"
        >
          ← The Main Issue of UUID
        </a>
        
        <span class="w-[1px]"></span>
        
        <a
          id="nextLink"
          href="https://kostyanetsky.me/notes/singapore-doll"
          class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 transition hover:bg-slate-50"
        >
          Singapore Doll →
        </a>
        
      </nav>



    </main>

    <!-- footer -->
    <footer class="mt-12 border-t border-slate-200">
      <div class="mx-auto w-full max-w-4xl px-4 py-8 text-sm text-slate-600">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
          <p>Vlad Kostyanetsky</p>
          <p>
            <a class="text-slate-900 underline decoration-slate-300 hover:decoration-slate-500" href="https://kostyanetsky.me/rss.xml">RSS</a>
            <span class="mx-2 text-slate-300">·</span>
            <a class="text-slate-900 underline decoration-slate-300 hover:decoration-slate-500" href="https://github.com/vkostyanetsky">GitHub</a>
            <span class="mx-2 text-slate-300">·</span>
            <a class="text-slate-900 underline decoration-slate-300 hover:decoration-slate-500" href="https://t.me/tell_me_alisa">Telegram</a>            
          </p>
        </div>
      </div>
    </footer>

  </body>
</html>